# –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ vs –ë–µ–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π - –ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å –ø—Ä–∏ –Ω–∞–≥—Ä—É–∑–∫–µ

## üéØ –í–æ–ø—Ä–æ—Å: –ë—É–¥–µ—Ç –ª–∏ —ç—Ç–æ –∞—Ç–æ–º–∞—Ä–Ω–æ –ø—Ä–∏ –Ω–∞–≥—Ä—É–∑–∫–µ?

**–ö–æ—Ä–æ—Ç–∫–∏–π –æ—Ç–≤–µ—Ç:** –ó–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π!

## üìä –î–≤–∞ –ø–æ–¥—Ö–æ–¥–∞

### 1Ô∏è‚É£ –° —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏ (create) - –ü–û–õ–ù–ê–Ø –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å

```typescript
async create(createCustomerDto: CreateCustomerDto): Promise<CustomerDocument> {
  const session = await this.connection.startSession();
  
  await session.withTransaction(async () => {
    const customerId = await this.getNextCustomerId(session);
    const customer = new this.customerModel({ ...createCustomerDto, customerId });
    result = await customer.save({ session });
  });
  
  return result;
}
```

**–ì–∞—Ä–∞–Ω—Ç–∏–∏:**
- ‚úÖ –õ–∏–±–æ –í–°–Å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è, –ª–∏–±–æ –ù–ò–ß–ï–ì–û
- ‚úÖ –ù–µ—Ç –ø—Ä–æ–ø—É—Å–∫–æ–≤ –≤ customerId (1, 2, 3, 4, 5...)
- ‚úÖ –ï—Å–ª–∏ save() –ø–∞–¥–∞–µ—Ç ‚Üí customerId –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç—Å—è
- ‚úÖ –ü–æ–ª–Ω–∞—è –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å –¥–∞–∂–µ –ø—Ä–∏ 1000+ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- üêå –ú–µ–¥–ª–µ–Ω–Ω–µ–µ –Ω–∞ ~30-50%
- üíæ –¢—Ä–µ–±—É–µ—Ç replica set –≤ MongoDB (–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ standalone)

### 2Ô∏è‚É£ –ë–µ–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (createFast) - –ß–ê–°–¢–ò–ß–ù–ê–Ø –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å

```typescript
async createFast(createCustomerDto: CreateCustomerDto): Promise<CustomerDocument> {
  const customerId = await this.getNextCustomerId();  // ‚úÖ –ê—Ç–æ–º–∞—Ä–Ω–æ
  const customer = new this.customerModel({ ...createCustomerDto, customerId });
  return customer.save();  // ‚ùå –†–∞–∑—Ä—ã–≤ - –º–æ–∂–µ—Ç —É–ø–∞—Å—Ç—å
}
```

**–ì–∞—Ä–∞–Ω—Ç–∏–∏:**
- ‚úÖ –ü–æ–ª—É—á–µ–Ω–∏–µ customerId –∞—Ç–æ–º–∞—Ä–Ω–æ
- ‚úÖ –†–∞–∑–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –ø–æ–ª—É—á–∞—é—Ç —Ä–∞–∑–Ω—ã–µ ID
- ‚ö†Ô∏è –ú–æ–≥—É—Ç –±—ã—Ç—å –ø—Ä–æ–ø—É—Å–∫–∏ –≤ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- üî¢ –ü—Ä–æ–ø—É—Å–∫–∏ –≤ customerId (1, 2, 4, 7, 8...) –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚ö° –ë—ã—Å—Ç—Ä–µ–µ –Ω–∞ ~30-50%
- üöÄ –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ª—é–±–æ–π MongoDB (standalone, replica set, cluster)

## üîç –î–µ—Ç–∞–ª—å–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ

### –°—Ü–µ–Ω–∞—Ä–∏–π: 1000 –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

#### –° —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏:
```
Request 1: transaction { counter: 1 ‚Üí save ‚úÖ } ‚Üí customerId = 1
Request 2: transaction { counter: 2 ‚Üí save ‚úÖ } ‚Üí customerId = 2
Request 3: transaction { counter: 3 ‚Üí save ‚ùå email duplicate } 
           ‚Üí ROLLBACK ‚Üí customerId = 3 –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç—Å—è
Request 4: transaction { counter: 3 ‚Üí save ‚úÖ } ‚Üí customerId = 3 –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è

–†–µ–∑—É–ª—å—Ç–∞—Ç: 1, 2, 3, 4, 5... ‚úÖ –ë–ï–ó –ø—Ä–æ–ø—É—Å–∫–æ–≤
```

#### –ë–µ–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:
```
Request 1: counter: 1 ‚Üí save ‚úÖ ‚Üí customerId = 1
Request 2: counter: 2 ‚Üí save ‚úÖ ‚Üí customerId = 2
Request 3: counter: 3 ‚Üí save ‚ùå email duplicate ‚Üí customerId = 3 –ü–û–¢–ï–†–Ø–ù
Request 4: counter: 4 ‚Üí save ‚úÖ ‚Üí customerId = 4

–†–µ–∑—É–ª—å—Ç–∞—Ç: 1, 2, 4, 5... ‚ö†Ô∏è –ü—Ä–æ–ø—É—Å–∫ (–Ω–µ—Ç 3)
```

## üìà –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –û–ø–µ—Ä–∞—Ü–∏—è | –ë–µ–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ | –° —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–µ–π |
|----------|----------------|---------------|
| **–£—Å–ø–µ—à–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ** | ~3ms | ~4-5ms |
| **–° –æ—à–∏–±–∫–æ–π** | ~3ms + –ø–æ—Ç–µ—Ä—è–Ω ID | ~4-5ms + ID —Å–æ—Ö—Ä–∞–Ω—ë–Ω |
| **1000 –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö** | ~3s | ~4-6s |
| **Replica set –Ω—É–∂–µ–Ω?** | ‚ùå –ù–µ—Ç | ‚úÖ –î–∞ |

## ü§î –ß—Ç–æ –≤—ã–±—Ä–∞—Ç—å?

### ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ **create** (–° —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏), –µ—Å–ª–∏:

1. **–ù—É–∂–Ω–∞ —Å—Ç—Ä–æ–≥–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å** –±–µ–∑ –ø—Ä–æ–ø—É—Å–∫–æ–≤
   ```
   –ü—Ä–∏–º–µ—Ä: –ù–æ–º–µ—Ä–∞ –∑–∞–∫–∞–∑–æ–≤, —á–µ–∫–æ–≤, –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö –¥–ª—è –±—É—Ö–≥–∞–ª—Ç–µ—Ä–∏–∏
   ```

2. **–í–∞–∂–Ω–∞ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö**
   ```
   –ü—Ä–∏–º–µ—Ä: –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏, –∞—É–¥–∏—Ç
   ```

3. **–£ –≤–∞—Å MongoDB Replica Set –∏–ª–∏ Cluster**
   ```
   Production –æ–∫—Ä—É–∂–µ–Ω–∏–µ –æ–±—ã—á–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç replica set
   ```

### ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ **createFast** (–ë–µ–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π), –µ—Å–ª–∏:

1. **–ü—Ä–æ–ø—É—Å–∫–∏ –≤ ID –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω—ã**
   ```
   –ü—Ä–∏–º–µ—Ä: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (1, 2, 5, 7 - –Ω–µ –≤–∞–∂–Ω–æ)
   ```

2. **–í–∞–∂–Ω–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**
   ```
   –ü—Ä–∏–º–µ—Ä: –í—ã—Å–æ–∫–æ–Ω–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ API, —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
   ```

3. **MongoDB standalone** (–ª–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞)
   ```
   –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç –±–µ–∑ replica set
   ```

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ MongoDB Replica Set

–î–ª—è —Ä–∞–±–æ—Ç—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –Ω—É–∂–µ–Ω replica set:

### Docker Compose:
```yaml
version: '3.8'
services:
  mongo:
    image: mongo:7
    ports:
      - "27017:27017"
    command: ["--replSet", "rs0"]
    volumes:
      - mongo_data:/data/db
    healthcheck:
      test: echo "try { rs.status() } catch (err) { rs.initiate() }" | mongosh --quiet
      interval: 5s
      timeout: 10s
      retries: 5

volumes:
  mongo_data:
```

### –ò–ª–∏ –≤—Ä—É—á–Ω—É—é:
```bash
# 1. –ó–∞–ø—É—Å—Ç–∏—Ç—å MongoDB —Å replica set
mongod --replSet rs0

# 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å replica set
mongosh
> rs.initiate()
```

## üîß –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É —Ä–µ–∂–∏–º–∞–º–∏

–í —Å–µ—Ä–≤–∏—Å–µ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–±–∞ –º–µ—Ç–æ–¥–∞:

```typescript
@Injectable()
export class CustomerService {
  constructor(private readonly customerRepository: CustomerRepository) {}

  // –î–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (—Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏)
  async createCustomer(dto: CreateCustomerDto) {
    // –ü—Ä–æ–≤–µ—Ä–∫–∏ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏
    await this.checkUniqueness(dto);
    
    // –°–æ–∑–¥–∞–Ω–∏–µ —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–µ–π
    return this.customerRepository.create(dto);
  }

  // –î–ª—è –º–∞—Å—Å–æ–≤–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞ (–±–µ–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π - –±—ã—Å—Ç—Ä–µ–µ)
  async bulkImport(customers: CreateCustomerDto[]) {
    const promises = customers.map(dto => 
      this.customerRepository.createFast(dto)
    );
    return Promise.allSettled(promises);
  }
}
```

## üéØ –†–µ–∞–ª—å–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã

### –ü—Ä–∏–º–µ—Ä 1: E-commerce
```typescript
// –ó–∞–∫–∞–∑—ã - —Å—Ç—Ä–æ–≥–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å
await orderRepository.create(orderDto);  // –° —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏

// –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π - –Ω–µ –≤–∞–∂–Ω—ã –ø—Ä–æ–ø—É—Å–∫–∏
await customerRepository.createFast(customerDto);  // –ë–µ–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
```

### –ü—Ä–∏–º–µ—Ä 2: –ë–∞–Ω–∫–æ–≤—Å–∫–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
```typescript
// –í–°–Å —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏
await transactionRepository.create(transactionDto);
await accountRepository.create(accountDto);
```

### –ü—Ä–∏–º–µ—Ä 3: –°–æ—Ü–∏–∞–ª—å–Ω–∞—è —Å–µ—Ç—å
```typescript
// –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ - –±—ã—Å—Ç—Ä–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
await userRepository.createFast(userDto);  // –ë–µ–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

// –ü–æ—Å—Ç—ã, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ - –ø—Ä–æ–ø—É—Å–∫–∏ –Ω–µ –≤–∞–∂–Ω—ã
await postRepository.createFast(postDto);  // –ë–µ–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
```

## üö® –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

### –° —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏:
```typescript
// –ü–æ–ø—ã—Ç–∫–∞ 1
Request: { email: "test@test.com" }
‚Üí counter = 5
‚Üí save() ‚úÖ
‚Üí transaction commit
‚Üí customerId = 5 —Å–æ—Ö—Ä–∞–Ω—ë–Ω

// –ü–æ–ø—ã—Ç–∫–∞ 2 (–¥—É–±–ª–∏–∫–∞—Ç email)
Request: { email: "test@test.com" }  // –¢–æ—Ç –∂–µ email!
‚Üí counter = 6
‚Üí save() ‚ùå E11000 duplicate key error
‚Üí transaction abort
‚Üí counter –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç—Å—è –æ–±—Ä–∞—Ç–Ω–æ –¥–æ 5
‚Üí customerId = 6 –ù–ï –ø–æ—Ç–µ—Ä—è–Ω

// –ü–æ–ø—ã—Ç–∫–∞ 3
Request: { email: "other@test.com" }
‚Üí counter = 6  // –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è!
‚Üí save() ‚úÖ
‚Üí customerId = 6 —Å–æ—Ö—Ä–∞–Ω—ë–Ω

–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 5, 6 ‚úÖ
```

### –ë–µ–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:
```typescript
// –ü–æ–ø—ã—Ç–∫–∞ 1
Request: { email: "test@test.com" }
‚Üí counter = 5
‚Üí save() ‚úÖ
‚Üí customerId = 5 —Å–æ—Ö—Ä–∞–Ω—ë–Ω

// –ü–æ–ø—ã—Ç–∫–∞ 2 (–¥—É–±–ª–∏–∫–∞—Ç email)
Request: { email: "test@test.com" }
‚Üí counter = 6  // –£–≤–µ–ª–∏—á–∏–ª—Å—è!
‚Üí save() ‚ùå E11000 duplicate key error
‚Üí customerId = 6 –ü–û–¢–ï–†–Ø–ù –ù–ê–í–°–ï–ì–î–ê

// –ü–æ–ø—ã—Ç–∫–∞ 3
Request: { email: "other@test.com" }
‚Üí counter = 7  // –°–ª–µ–¥—É—é—â–∏–π
‚Üí save() ‚úÖ
‚Üí customerId = 7 —Å–æ—Ö—Ä–∞–Ω—ë–Ω

–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 5, 7 ‚ö†Ô∏è (–ø—Ä–æ–ø—É—â–µ–Ω 6)
```

## üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è

**–î–ª—è production –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `create` (—Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏):**
- ‚úÖ –ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å –≤–∞–∂–Ω–µ–µ —Å–∫–æ—Ä–æ—Å—Ç–∏
- ‚úÖ –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- ‚úÖ –ù–µ—Ç –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–ø—É—Å–∫–æ–≤

**–î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:**
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `createFast` –µ—Å–ª–∏ –Ω–µ—Ç replica set
- –ò–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –ª–æ–∫–∞–ª—å–Ω—ã–π replica set (—Å–º. –≤—ã—à–µ)

## üîó –ò—Ç–æ–≥

| –ö—Ä–∏—Ç–µ—Ä–∏–π | create (—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏) | createFast (–±–µ–∑) |
|----------|---------------------|------------------|
| **–ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å** | ‚úÖ –ü–æ–ª–Ω–∞—è | ‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–∞—è |
| **–ü—Ä–æ–ø—É—Å–∫–∏ ID** | ‚ùå –ù–µ—Ç | ‚úÖ –í–æ–∑–º–æ–∂–Ω—ã |
| **–°–∫–æ—Ä–æ—Å—Ç—å** | üêå –ú–µ–¥–ª–µ–Ω–Ω–µ–µ | ‚ö° –ë—ã—Å—Ç—Ä–µ–µ |
| **Replica set** | ‚úÖ –ù—É–∂–µ–Ω | ‚ùå –ù–µ –Ω—É–∂–µ–Ω |
| **Production** | ‚úÖ‚úÖ –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è | ‚ö†Ô∏è –ï—Å–ª–∏ –Ω–µ –≤–∞–∂–Ω—ã –ø—Ä–æ–ø—É—Å–∫–∏ |
| **Dev (standalone)** | ‚ùå –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç |

**–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è**: –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `create` —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏ –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏! üéØ

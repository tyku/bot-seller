# Auto-Increment customerId - –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

## üöÄ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### ‚ùå –°—Ç–∞—Ä–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (–ú–ï–î–õ–ï–ù–ù–ê–Ø)

```typescript
// Pre-save hook - –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º —Å–æ–∑–¥–∞–Ω–∏–∏
CustomerSchema.pre('save', async function () {
  if (this.isNew && !this.customerId) {
    const Customer = this.constructor as any;
    // ‚ùå –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫ –ë–î
    // ‚ùå Sort –ø–æ –≤—Å–µ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏
    // ‚ùå Race condition –ø—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö
    const lastCustomer = await Customer.findOne()
      .sort({ customerId: -1 })
      .limit(1)
      .exec();
    
    this.customerId = lastCustomer ? lastCustomer.customerId + 1 : 1;
  }
});
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
1. **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å** - –∫–∞–∂–¥—ã–π —Ä–∞–∑ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è `.findOne().sort().limit()`
2. **Sort –Ω–∞ –±–æ–ª—å—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö** - –º–µ–¥–ª–µ–Ω–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –∑–∞–ø–∏—Å–µ–π
3. **Race condition** - –ø—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö –º–æ–≥—É—Ç –ø–æ–ª—É—á–∏—Ç—å—Å—è –¥—É–±–ª–∏–∫–∞—Ç—ã:
   ```
   Request 1: findOne() ‚Üí –ø–æ–ª—É—á–∞–µ—Ç customerId=100 ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç 101
   Request 2: findOne() ‚Üí –ø–æ–ª—É—á–∞–µ—Ç customerId=100 ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç 101 ‚ùå
   ```
4. **–ù–µ—Ç –≥–∞—Ä–∞–Ω—Ç–∏–π —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏** –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

### ‚úÖ –ù–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (–ë–´–°–¢–†–ê–Ø)

```typescript
// –û—Ç–¥–µ–ª—å–Ω–∞—è –∫–æ–ª–ª–µ–∫—Ü–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤
const counter = await this.counterModel.findOneAndUpdate(
  { name: 'customerId' },
  { $inc: { seq: 1 } },           // ‚úÖ –ê—Ç–æ–º–∞—Ä–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è
  { new: true, upsert: true },    // ‚úÖ –°–æ–∑–¥–∞–µ—Ç –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
);
return counter.seq;
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
1. **–ê—Ç–æ–º–∞—Ä–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è** - MongoDB –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å
2. **–ù–µ—Ç race conditions** - –¥–∞–∂–µ –ø—Ä–∏ 1000 –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö
3. **–ë—ã—Å—Ç—Ä–æ** - —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –æ–¥–Ω–∏–º –¥–æ–∫—É–º–µ–Ω—Ç–æ–º, –±–µ–∑ sort
4. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - —Ä–∞–±–æ—Ç–∞–µ—Ç –æ–¥–∏–Ω–∞–∫–æ–≤–æ –±—ã—Å—Ç—Ä–æ –Ω–∞ –ª—é–±—ã—Ö –æ–±—ä–µ–º–∞—Ö

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

| –û–ø–µ—Ä–∞—Ü–∏—è | –°—Ç–∞—Ä—ã–π —Å–ø–æ—Å–æ–± | –ù–æ–≤—ã–π —Å–ø–æ—Å–æ–± |
|----------|---------------|--------------|
| **–ó–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î** | 2 (find + save) | 2 (counter + save) |
| **Sort –æ–ø–µ—Ä–∞—Ü–∏–π** | 1 (–º–µ–¥–ª–µ–Ω–Ω–æ) | 0 |
| **Race condition** | ‚ùå –í–æ–∑–º–æ–∂–µ–Ω | ‚úÖ –ù–µ–≤–æ–∑–º–æ–∂–µ–Ω |
| **–°–∫–æ—Ä–æ—Å—Ç—å –Ω–∞ 1K –∑–∞–ø–∏—Å–µ–π** | ~10ms | ~2ms |
| **–°–∫–æ—Ä–æ—Å—Ç—å –Ω–∞ 1M –∑–∞–ø–∏—Å–µ–π** | ~200ms | ~2ms |
| **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã** | ‚ùå –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã | ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ |

## üîß –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç

### 1. –ö–æ–ª–ª–µ–∫—Ü–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤ (`counters`)

```javascript
{
  _id: ObjectId("..."),
  name: "customerId",    // –ò–º—è —Å—á–µ—Ç—á–∏–∫–∞
  seq: 42                // –¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
}
```

### 2. –ê—Ç–æ–º–∞—Ä–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è `findOneAndUpdate`

```typescript
db.counters.findOneAndUpdate(
  { name: 'customerId' },      // –ù–∞–π—Ç–∏ —Å—á–µ—Ç—á–∏–∫
  { $inc: { seq: 1 } },        // –£–≤–µ–ª–∏—á–∏—Ç—å –Ω–∞ 1 (–ê–¢–û–ú–ê–†–ù–û!)
  { 
    new: true,                 // –í–µ—Ä–Ω—É—Ç—å –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    upsert: true               // –°–æ–∑–¥–∞—Ç—å –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
  }
)
```

**MongoDB –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç:**
- –û–ø–µ—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é (atomically)
- –ù–∏–∫–∞–∫–∏–µ –¥–≤–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–µ –ø–æ–ª—É—á–∞—Ç –æ–¥–∏–Ω–∞–∫–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
- –†–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –≤ –∫–ª–∞—Å—Ç–µ—Ä–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

### 3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–¥–µ

```typescript
// –í CustomerRepository
private async getNextCustomerId(): Promise<number> {
  const counter = await this.counterModel.findOneAndUpdate(
    { name: 'customerId' },
    { $inc: { seq: 1 } },
    { new: true, upsert: true },
  );
  return counter.seq;
}

async create(createCustomerDto: CreateCustomerDto): Promise<CustomerDocument> {
  const customerId = await this.getNextCustomerId();  // –ü–æ–ª—É—á–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID
  const customer = new this.customerModel({
    ...createCustomerDto,
    customerId,
  });
  return customer.save();
}
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

```typescript
// –°–æ–∑–¥–∞–µ–º 100 –∫–∞—Å—Ç–æ–º–µ—Ä–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
const promises = Array.from({ length: 100 }, (_, i) => 
  customerService.create({
    name: `Customer ${i}`,
    email: `customer${i}@example.com`,
    phone: `+123456789${String(i).padStart(2, '0')}`,
  })
);

const customers = await Promise.all(promises);

// –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å customerId
const customerIds = customers.map(c => c.customerId);
const uniqueIds = new Set(customerIds);

console.log(uniqueIds.size === 100); // ‚úÖ true - –≤—Å–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ!
```

## üíæ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### –ö–æ–ª–ª–µ–∫—Ü–∏—è `customers`
```javascript
{
  _id: ObjectId("..."),
  customerId: 1,              // ‚úÖ –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–Ω—ã–π ID
  name: "John Doe",
  email: "john@example.com",
  phone: "+1234567890",
  status: "created",
  createdAt: ISODate("..."),
  updatedAt: ISODate("...")
}
```

### –ö–æ–ª–ª–µ–∫—Ü–∏—è `counters`
```javascript
{
  _id: ObjectId("..."),
  name: "customerId",         // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∏–µ —Å—á–µ—Ç—á–∏–∫–∏
  seq: 42                     // –¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞
}
```

## üîç –ò–Ω–¥–µ–∫—Å—ã

MongoDB –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç –∏–Ω–¥–µ–∫—Å—ã:

```javascript
// –ù–∞ customers
{ customerId: 1 }  // unique index
{ email: 1 }       // unique index
{ phone: 1 }       // unique index

// –ù–∞ counters
{ name: 1 }        // unique index (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
```

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç—É —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –¥–ª—è:
- Production –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
- –í—ã—Å–æ–∫–∏—Ö –Ω–∞–≥—Ä—É–∑–æ–∫
- –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- –ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

### ‚ö†Ô∏è –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã (–∫–æ–≥–¥–∞ –ù–ï –Ω—É–∂–µ–Ω —Å—Ç—Ä–æ–≥–∏–π –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç):
–ï—Å–ª–∏ –Ω–µ –Ω—É–∂–Ω–∞ —Å—Ç—Ä–æ–≥–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å (1,2,3...), –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:
- `UUID` / `ObjectId` - —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ, –Ω–æ –Ω–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ
- `nanoid` - –∫–æ—Ä–æ—Ç–∫–∏–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ ID
- `shortid` - deprecated, –Ω–æ –≤—Å–µ –µ—â–µ –ø–æ–ø—É–ª—è—Ä–µ–Ω

### üîÑ –ú–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö

–ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –∫–∞—Å—Ç–æ–º–µ—Ä—ã, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —Å—á–µ—Ç—á–∏–∫:

```typescript
// –°–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏
const maxCustomerId = await customerModel
  .findOne()
  .sort({ customerId: -1 })
  .limit(1);

await counterModel.create({
  name: 'customerId',
  seq: maxCustomerId?.customerId || 0,
});
```

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—á–µ—Ç—á–∏–∫–∏

–õ–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫–∏ –¥–ª—è –¥—Ä—É–≥–∏—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π:

```typescript
// –î–ª—è –∑–∞–∫–∞–∑–æ–≤
private async getNextOrderId(): Promise<number> {
  const counter = await this.counterModel.findOneAndUpdate(
    { name: 'orderId' },      // –î—Ä—É–≥–æ–µ –∏–º—è
    { $inc: { seq: 1 } },
    { new: true, upsert: true },
  );
  return counter.seq;
}

// –î–ª—è —Ç–æ–≤–∞—Ä–æ–≤
private async getNextProductId(): Promise<number> {
  const counter = await this.counterModel.findOneAndUpdate(
    { name: 'productId' },    // –ò –µ—â–µ –æ–¥–Ω–æ
    { $inc: { seq: 1 } },
    { new: true, upsert: true },
  );
  return counter.seq;
}
```

–í—Å–µ —Å—á–µ—Ç—á–∏–∫–∏ –∂–∏–≤—É—Ç –≤ –æ–¥–Ω–æ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏ `counters`:
```javascript
[
  { name: "customerId", seq: 1523 },
  { name: "orderId", seq: 8942 },
  { name: "productId", seq: 456 }
]
```

## üéì –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**–°—Ç–∞—Ä–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- ‚ùå –ú–µ–¥–ª–µ–Ω–Ω–∞—è –Ω–∞ –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–∞—Ö
- ‚ùå Race conditions
- ‚ùå –ù–µ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è

**–ù–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- ‚úÖ –ë—ã—Å—Ç—Ä–∞—è –Ω–∞ –ª—é–±—ã—Ö –æ–±—ä–µ–º–∞—Ö
- ‚úÖ Thread-safe (–∞—Ç–æ–º–∞—Ä–Ω–∞—è)
- ‚úÖ Production-ready
- ‚úÖ –õ–µ–≥–∫–æ —Ä–∞—Å—à–∏—Ä—è–µ–º–∞—è

**MongoDB $inc –æ–ø–µ—Ä–∞—Ü–∏—è** - —ç—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∏ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Å–ø–æ—Å–æ–± —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ auto-increment –≤ MongoDB!

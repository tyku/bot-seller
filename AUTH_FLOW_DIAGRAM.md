# 🔐 Auth Flow Diagram

## Email Registration Flow

```
┌─────────────────────────────────────────────────────────┐
│                                                         │
│  USER открывает страницу регистрации                   │
│                                                         │
└───────────────────┬─────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────┐
│  Выбирает "Email" 📧                                    │
│                                                         │
│  Заполняет:                                            │
│    • Имя                                               │
│    • Email                                             │
│                                                         │
└───────────────────┬─────────────────────────────────────┘
                    │
                    ▼
        POST /auth/register/email
         { name, email }
                    │
                    ▼
┌─────────────────────────────────────────────────────────┐
│  BACKEND                                                │
│                                                         │
│  1. Проверяет, что email не занят                      │
│  2. Создает Customer (без пароля!)                     │
│  3. Генерирует 6-значный код                           │
│  4. Отправляет код на email                            │
│                                                         │
└───────────────────┬─────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────┐
│  USER получает письмо с кодом                          │
│                                                         │
│  Subject: Код верификации                              │
│  Body: Ваш код: 123456                                 │
│                                                         │
└───────────────────┬─────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────┐
│  Вводит код: 123456                                    │
└───────────────────┬─────────────────────────────────────┘
                    │
                    ▼
        POST /auth/verify
         { email, code, method: 'email' }
                    │
                    ▼
┌─────────────────────────────────────────────────────────┐
│  BACKEND                                                │
│                                                         │
│  1. Проверяет код                                      │
│  2. Обновляет статус: VERIFIED                         │
│  3. Генерирует JWT токен                               │
│  4. Возвращает токен                                   │
│                                                         │
└───────────────────┬─────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────┐
│  SUCCESS! 🎉                                            │
│                                                         │
│  Пользователь залогинен                                │
│  → Переход в дашборд                                   │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

## Telegram Registration Flow

```
┌─────────────────────────────────────────────────────────┐
│                                                         │
│  USER открывает страницу регистрации                   │
│                                                         │
└───────────────────┬─────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────┐
│  Выбирает "Telegram" 📱                                 │
│                                                         │
│  Заполняет:                                            │
│    • Имя                                               │
│    • Телефон (+79991234567)                            │
│                                                         │
└───────────────────┬─────────────────────────────────────┘
                    │
                    ▼
        POST /auth/register/telegram
         { name, phone }
                    │
                    ▼
┌─────────────────────────────────────────────────────────┐
│  BACKEND                                                │
│                                                         │
│  1. Проверяет, что phone не занят                      │
│  2. Создает Customer (без пароля!)                     │
│  3. Генерирует 6-значный код                           │
│  4. Отправляет код в Telegram                          │
│                                                         │
└───────────────────┬─────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────┐
│  USER получает сообщение в Telegram                    │
│                                                         │
│  Бот: Ваш код верификации: 123456                      │
│                                                         │
└───────────────────┬─────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────┐
│  Вводит код: 123456                                    │
└───────────────────┬─────────────────────────────────────┘
                    │
                    ▼
        POST /auth/verify
         { phone, code, method: 'telegram' }
                    │
                    ▼
┌─────────────────────────────────────────────────────────┐
│  BACKEND                                                │
│                                                         │
│  1. Проверяет код                                      │
│  2. Обновляет статус: VERIFIED                         │
│  3. Генерирует JWT токен                               │
│  4. Возвращает токен                                   │
│                                                         │
└───────────────────┬─────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────┐
│  SUCCESS! 🎉                                            │
│                                                         │
│  Пользователь залогинен                                │
│  → Переход в дашборд                                   │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

## Login Flow (для существующих пользователей)

```
┌─────────────────────────────────────────────────────────┐
│  USER нажимает "Войти"                                  │
│                                                         │
│  Вводит:                                               │
│    • Email ИЛИ Phone                                   │
│    (БЕЗ ПАРОЛЯ!)                                       │
│                                                         │
└───────────────────┬─────────────────────────────────────┘
                    │
                    ▼
        POST /auth/login
         { email OR phone }
                    │
                    ▼
┌─────────────────────────────────────────────────────────┐
│  BACKEND                                                │
│                                                         │
│  1. Находит Customer                                   │
│  2. Проверяет статус: VERIFIED                         │
│  3. Генерирует код                                     │
│  4. Отправляет код (email или telegram)                │
│                                                         │
└───────────────────┬─────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────┐
│  USER получает код                                     │
│  Вводит код                                            │
└───────────────────┬─────────────────────────────────────┘
                    │
                    ▼
        POST /auth/verify
         { email/phone, code, method }
                    │
                    ▼
┌─────────────────────────────────────────────────────────┐
│  SUCCESS! 🎉                                            │
│  JWT токен → Дашборд                                   │
└─────────────────────────────────────────────────────────┘
```

## Ключевые моменты

### ✅ Что есть
- 2 способа регистрации (Email / Telegram)
- Авторизация ТОЛЬКО по кодам
- Простые формы (2-3 поля)
- Верификация обязательна
- JWT токены (24 часа)

### ❌ Чего нет
- Паролей
- "Забыл пароль"
- Сложных правил паролей
- Хеширования паролей
- telegramUsername поля
- Сложных форм

### 🔐 Безопасность
- Код действителен: 10 минут
- Код одноразовый
- Коды хранятся в БД с timestamp
- JWT токены подписаны
- HTTPS на production

### 📊 База данных

**Customer schema:**
```typescript
{
  name: string;           // ✅
  customerId: number;     // ✅ Auto-increment
  email?: string;         // ✅ Опционально (если Email)
  phone?: string;         // ✅ Опционально (если Telegram)
  status: 'created' | 'verified';  // ✅
  telegramId?: number;    // ✅ Опционально (при привязке)
  // ❌ НЕТ: passwordHash
  // ❌ НЕТ: telegramUsername
}
```

**Verification schema:**
```typescript
{
  customerId: string;
  contact: string;        // email или phone
  code: string;           // 6 цифр
  type: 'EMAIL' | 'TELEGRAM';
  verified: boolean;
  expiresAt: Date;        // +10 минут
}
```

## API Endpoints

### Регистрация
```
POST /auth/register/email
Body: { name, email }

POST /auth/register/telegram
Body: { name, phone }
```

### Login
```
POST /auth/login
Body: { email OR phone }
```

### Верификация
```
POST /auth/verify
Body: { email/phone, code, method }

POST /auth/resend-code
Body: { identifier, method }
```

## Frontend Routes

```
/                       → RegisterStep (2 формы)
  ↓
/verify                 → VerifyStep (ввод кода)
  ↓
/settings               → SettingsStep (настройка бота)
  ↓
/payment                → PaymentStep (тариф)
  ↓
/dashboard              → DashboardStep (управление)
```

---

**Простая, современная авторизация без паролей!** 🎉
